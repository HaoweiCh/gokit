# (五)go-kit微服务之限流

原文链接

1. [Micro-services Using go-kit: Rate Limiting](http://www.ru-rocker.com/2017/03/19/micro-services-using-go-kit-rate-limiting/)

## 1. 概述

在前面的文章中, 我们在原来的随机文本服务中添加了日志功能, 但是对于生产环境还是不够可靠. 我们仍然需要在服务中继续添加中间件以增强服务能力.

所以, 在这篇文章中, 我将介绍一种中间件功能, 类似于仪表控制(真别扭, 没读懂). 我将在中间件中实现限流的功能.

## 2. 限流服务

在微服务的世界里, 我们经常需要对接口进行请求次数的限制, 以保护服务不会过载. 因为有时一个请求可能耗费大量CPU(或是内存)资源. 单位时候内, 大量的访问请求可能会导致服务性能的下降.

### 2.1 Token Bucket Limiter(令牌桶)

为了实现限流的功能, 我需要添加一种基于token的限流算法. 简单来说, 我们拥有一个令牌桶(其中有一定数量的令牌), 每个请求都会从中取得一个令牌, 以便处理接下来的逻辑. 如果桶中已经没有令牌, 那么此次请求便无法完成. 当前令牌桶在一定时间内会重新充满. 关于此次算法的更多令牌, 可以参考[这里](https://en.wikipedia.org/wiki/Token_bucket)

在golang中, 有一个库[juju](https://github.com/juju/ratelimit)实现了这个算法. 此外go-kit有一个内置的中间件也实现了这个算法, 这将极大简化我们的工作.

### 2.2 go-kit中间件

在go-kit中